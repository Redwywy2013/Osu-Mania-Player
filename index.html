<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>osu!mania Web Player (Minimal Format)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { margin:0; background:#0f1115; color:#e6ebf2; font-family:sans-serif; display:flex; height:100vh; }
  #main { flex:1; display:flex; flex-direction:column; }
  #topbar { height:50px; background:#161b24; display:flex; align-items:center; justify-content:space-between; padding:0 16px; }
  #stage { flex:1; display:flex; overflow:hidden; }
  #sidebar { width:300px; background:#1a1f29; overflow-y:auto; border-left:1px solid #0b0e13; }
  #songlist { padding:8px; }
  .song { margin:6px 0; border:1px solid #222; border-radius:8px; overflow:hidden; }
  .song .head { padding:8px 12px; background:#151a23; cursor:pointer; display:flex; justify-content:space-between; }
  .song .diffs { display:none; background:#10141b; }
  .song.open .diffs { display:block; }
  .song .diffs button { display:block; width:100%; padding:8px 12px; background:none; border:0; color:#e6ebf2; text-align:left; cursor:pointer; }
  .song .diffs button:hover { background:#18202c; }
  #gamewrap { flex:1; display:flex; align-items:center; justify-content:center; background:#000; position:relative; }
  #canvas { background:#000; border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,.5); }
  #overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); }
  #overlay .card { background:#1a1f29; padding:20px; border-radius:12px; text-align:center; color:#fff; }
  .btn { background:#2a5fff; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin:4px; }
  .btn:hover { filter:brightness(1.1); }
</style>
</head>
<body>
<div id="main">
  <div id="topbar">
    <div>osu!mania Web Player</div>
    <div>
      <button id="btnBack" class="btn" style="display:none">Back</button>
    </div>
  </div>
  <div id="stage">
    <div id="gamewrap">
      <canvas id="canvas" width="800" height="600"></canvas>
      <div id="overlay"><div class="card">
        <h3>Paused</h3>
        <button class="btn" id="resumeBtn">Resume</button>
        <button class="btn" id="restartBtn">Restart</button>
        <button class="btn" id="quitBtn">Quit</button>
      </div></div>
    </div>
    <div id="sidebar"><div id="songlist">Loading songs…</div></div>
  </div>
</div>
<script>
const API_URL = "https://api.github.com/repos/Redwywy2013/Osu-Mania-Player/contents/Songs";
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const songListDiv = document.getElementById("songlist");
const overlay = document.getElementById("overlay");
const btnBack = document.getElementById("btnBack");
const resumeBtn = document.getElementById("resumeBtn");
const restartBtn = document.getElementById("restartBtn");
const quitBtn = document.getElementById("quitBtn");

let repoFiles = [], currentPack=null, audio=null, bgImage=null;
let game=null;
let scrollSpeed=0.5, volume=1, globalOffset=0;

/* -----------------------------
   Fetch and render song list
----------------------------- */
async function listSongs(){
  const res=await fetch(API_URL); const data=await res.json();
  repoFiles=data.filter(f=>f.name.endsWith(".osuhtml"));
  renderSongList();
}
function renderSongList(){
  songListDiv.innerHTML="";
  repoFiles.forEach(file=>{
    const el=document.createElement("div"); el.className="song";
    const head=document.createElement("div"); head.className="head"; head.textContent=file.name.replace(".osuhtml","");
    const diffs=document.createElement("div"); diffs.className="diffs";
    el.appendChild(head); el.appendChild(diffs);
    head.onclick=async()=>{
      el.classList.toggle("open");
      if(el.classList.contains("open")){
        const text=await fetch(file.download_url).then(r=>r.text());
        currentPack=parseOsuhtml(text);
        diffs.innerHTML="";
        for(const diff in currentPack.difficulties){
          const b=document.createElement("button"); b.textContent=diff;
          b.onclick=()=>startGame(diff);
          diffs.appendChild(b);
        }
      }
    };
    songListDiv.appendChild(el);
  });
}

/* -----------------------------
   Minimal format parser
----------------------------- */
function parseOsuhtml(text) {
  const pack = { title:"", difficulties:{}, background:"", audio:"" };
  const at = text.match(/^Artist - Title:\s*(.+)$/m);
  if (at) pack.title = at[1].trim();

  const lines = text.split(/\r?\n/);
  let currentDiff = null;
  let currentMeta = {};
  let hitObjects = [];

  for (let line of lines) {
    if (line.startsWith("[") && line.endsWith("]:")) {
      if (currentDiff) {
        pack.difficulties[currentDiff] = {
          mapper: currentMeta.mapper || "Unknown",
          keys: parseInt(currentMeta.keys || "4"),
          hitObjects: hitObjects
        };
      }
      currentDiff = line.slice(1, -2).trim();
      currentMeta = {};
      hitObjects = [];
    }
    else if (line.startsWith("Mapper:")) {
      currentMeta.mapper = line.replace("Mapper:","").trim();
    }
    else if (line.startsWith("Keys:")) {
      currentMeta.keys = line.replace("Keys:","").trim();
    }
    else if (line.startsWith("HitObjects:")) {
      // nothing, actual notes come after
    }
    else if (line.match(/^\d+,\d+,\d+/)) {
      const parts = line.split(",");
      const x = parseInt(parts[0]);
      const start = parseInt(parts[1]);
      const type = parseInt(parts[2]);
      const end = parts[3] ? parseInt(parts[3]) : null;
      hitObjects.push({ x, t:start, type, end, judged:false });
    }
    else if (line.startsWith("Background:")) {
      pack.background = line.replace("Background:","").trim();
    }
    else if (line.startsWith("Audio Data:")) {
      pack.audio = line.replace("Audio Data:","").trim();
    }
  }
  if (currentDiff) {
    pack.difficulties[currentDiff] = {
      mapper: currentMeta.mapper || "Unknown",
      keys: parseInt(currentMeta.keys || "4"),
      hitObjects: hitObjects
    };
  }
  return pack;
}

/* -----------------------------
   Gameplay
----------------------------- */
function startGame(diff){
  const data = currentPack.difficulties[diff];
  game = {
    diffName: diff,
    numKeys: data.keys,
    hitObjects: data.hitObjects,
    lineY: canvas.height-60,
    columnWidth: canvas.width/data.keys,
    stats:{score:0,combo:0}
  };

  if(audio){ audio.pause(); }
  audio = new Audio(currentPack.audio); audio.volume=volume;
  if(currentPack.background){ bgImage=new Image(); bgImage.src=currentPack.background; }

  document.getElementById("sidebar").style.display="none";
  btnBack.style.display="inline-block";
  overlay.style.display="none";

  audio.currentTime=0; audio.play();
  requestAnimationFrame(loop);
}

function loop(){
  if(!game||!audio)return;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // BG
  if(bgImage) drawCoverImage(bgImage);

  const cw = game.columnWidth, lineY = game.lineY;
  ctx.fillStyle="#fff"; ctx.fillRect(0,lineY,canvas.width,4);
  for(let i=0;i<game.numKeys;i++){
    ctx.strokeStyle="rgba(255,255,255,.1)";
    ctx.strokeRect(i*cw,0,cw,canvas.height);
  }

  const now = audio.currentTime*1000+globalOffset, pxPerMs=scrollSpeed*0.6;
  for(const n of game.hitObjects){
    const col = Math.floor(n.x * game.numKeys / 512);
    const dt = n.t - now, y = lineY - dt*pxPerMs;
    if(y<-200||y>canvas.height+400) continue;
    const xx = col*cw+4, w=cw-8;
    if(n.end){ const h=(n.end-n.t)*pxPerMs; ctx.fillStyle="#5bd1ff"; ctx.fillRect(xx,y-h,w,h); }
    else { ctx.fillStyle="#7ec8ff"; ctx.fillRect(xx,y-12,w,24); }
  }

  ctx.fillStyle="#fff"; ctx.font="14px sans-serif";
  ctx.fillText(`Notes: ${game.hitObjects.length}`,10,20);
  ctx.fillText(`${game.numKeys}K • ${game.diffName}`,10,40);

  if(!audio.paused) requestAnimationFrame(loop);
}
function drawCoverImage(img){
  const iw=img.width, ih=img.height, scale=Math.max(canvas.width/iw,canvas.height/ih);
  ctx.globalAlpha=0.3;
  ctx.drawImage(img,(canvas.width-iw*scale)/2,(canvas.height-ih*scale)/2,iw*scale,ih*scale);
  ctx.globalAlpha=1;
}

/* -----------------------------
   Controls
----------------------------- */
btnBack.onclick=()=>{ if(audio) audio.pause(); game=null;
  document.getElementById("sidebar").style.display="block"; btnBack.style.display="none"; ctx.clearRect(0,0,canvas.width,canvas.height);
};
resumeBtn.onclick=()=>{ overlay.style.display="none"; audio.play(); }
restartBtn.onclick=()=>{ if(audio) audio.currentTime=0; overlay.style.display="none"; audio.play(); }
quitBtn.onclick=()=>btnBack.click();
window.addEventListener("keydown",e=>{
  if(e.code==="Escape"&&game){
    overlay.style.display=overlay.style.display==="none"?"flex":"none";
    if(overlay.style.display==="flex") audio.pause(); else audio.play();
  }
});

/* -----------------------------
   Init
----------------------------- */
listSongs();
</script>
</body>
</html>
