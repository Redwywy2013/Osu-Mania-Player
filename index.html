<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>osu!mania Web Player</title>
<style>
  body { margin:0; background:#111; color:white; font-family:sans-serif; text-align:center; }
  #loader, #menu, #game { display:none; }
  canvas { background:#000; display:block; margin:0 auto; }
  button { margin:5px; padding:10px; }
</style>
</head>
<body>
<h1>osu!mania Web Player</h1>

<div id="loader">
  <h2>Load .osuhtml file</h2>
  <input type="file" id="fileInput" accept=".osuhtml">
</div>

<div id="menu">
  <h2 id="songTitle"></h2>
  <h3>Select Difficulty</h3>
  <div id="diffList"></div>
</div>

<div id="game">
  <canvas id="gameCanvas" width="800" height="600"></canvas>
</div>

<script>
const fileInput = document.getElementById("fileInput");
const menuDiv = document.getElementById("menu");
const songTitleEl = document.getElementById("songTitle");
const diffList = document.getElementById("diffList");
const gameDiv = document.getElementById("game");
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let songData = {};
let notes = [];
let audio, bgImage;
let keyStates = {};
let startOffset = 0; // when audio starts

fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  parseOsuhtml(text);
});

function parseOsuhtml(text) {
  songData = { difficulties: {} };

  // Parse artist-title
  const atMatch = text.match(/^Artist - Title:\s*(.+)$/m);
  if (atMatch) songData.title = atMatch[1];

  // Parse difficulties
  const diffRegex = /\[(.+?)\]:\n([\s\S]*?)(?=^\[|\nBackground:|\nAudio Data:|$)/gm;
  let diffMatch;
  while ((diffMatch = diffRegex.exec(text)) !== null) {
    songData.difficulties[diffMatch[1]] = diffMatch[2].trim();
  }

  // Parse background
  const bgMatch = text.match(/Background:\s*(data:image\/.+)$/m);
  if (bgMatch) {
    songData.background = bgMatch[1];
    bgImage = new Image();
    bgImage.src = songData.background;
  }

  // Parse audio
  const audioMatch = text.match(/Audio Data:\s*(data:audio\/.+)$/m);
  if (audioMatch) songData.audio = audioMatch[1];

  showMenu();
}

function showMenu() {
  document.getElementById("loader").style.display = "none";
  menuDiv.style.display = "block";
  songTitleEl.textContent = songData.title || "Unknown Song";

  diffList.innerHTML = "";
  for (let diffName in songData.difficulties) {
    let btn = document.createElement("button");
    btn.textContent = diffName;
    btn.onclick = () => startGame(diffName);
    diffList.appendChild(btn);
  }
}

function parseOsuContent(osuText) {
  let hitObjects = [];
  let lines = osuText.split("\n");
  let section = "";
  for (let line of lines) {
    line = line.trim();
    if (line.startsWith("[") && line.endsWith("]")) {
      section = line;
      continue;
    }
    if (section === "[HitObjects]" && line.length > 0) {
      let parts = line.split(",");
      let x = parseInt(parts[0]);
      let time = parseInt(parts[2]);
      let type = parseInt(parts[3]);
      let endTime = parts[5] ? parseInt(parts[5]) : null;
      let column = Math.floor(x / (512/4));
      hitObjects.push({time, column, type, endTime, hit:false});
    }
  }
  return hitObjects;
}

function startGame(diffName) {
  menuDiv.style.display = "none";
  gameDiv.style.display = "block";

  notes = parseOsuContent(songData.difficulties[diffName]);
  audio = new Audio(songData.audio);
  audio.play();
  startOffset = performance.now() - audio.currentTime * 1000;

  requestAnimationFrame(gameLoop);
}

function gameLoop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw background
  if (bgImage) {
    ctx.globalAlpha = 0.3;
    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    ctx.globalAlpha = 1.0;
  }

  let currentTime = audio.currentTime * 1000; // ms
  let lineY = 550;
  let colWidth = canvas.width / 4;

  // Draw judgment line
  ctx.fillStyle = "white";
  ctx.fillRect(0,lineY,canvas.width,5);

  // Draw columns
  for (let i=0;i<4;i++) {
    ctx.strokeStyle="#444";
    ctx.strokeRect(i*colWidth,0,colWidth,canvas.height);
  }

  // Draw notes
  ctx.fillStyle="cyan";
  let speed = 0.3; // px per ms
  notes.forEach(n=>{
    let timeToHit = n.time - currentTime;
    let y = lineY - timeToHit * speed;
    if (!n.hit) {
      ctx.fillRect(n.column*colWidth+5,y,colWidth-10,20);
    }
  });

  if (!audio.paused) requestAnimationFrame(gameLoop);
}

// Key controls
window.addEventListener("keydown", e => keyStates[e.code] = true);
window.addEventListener("keyup", e => keyStates[e.code] = false);
</script>
</body>
</html>
