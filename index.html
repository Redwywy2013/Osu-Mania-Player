<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>osu!mania Web Player</title>
<style>
  body { margin:0; background:#111; color:white; font-family:sans-serif; display:flex; height:100vh; }
  #sidebar { width:300px; background:#222; overflow-y:auto; padding:10px; }
  #main { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  canvas { background:#000; display:block; margin:auto; }
  .song { margin:5px 0; cursor:pointer; padding:5px; background:#333; border-radius:5px; }
  .diff { margin-left:15px; cursor:pointer; color:#bbb; }
  #settings { padding:10px; border-top:1px solid #444; }
</style>
</head>
<body>
<div id="sidebar">
  <h3>Songs</h3>
  <div id="songList"></div>
  <div id="settings">
    <h4>Settings</h4>
    <label>Note Speed: <input type="range" id="speedSlider" min="0.1" max="1" step="0.05" value="0.3"></label><br>
    <label>Volume: <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1"></label><br>
    <small>Keys: A / S / K / L (customizable later)</small>
  </div>
</div>
<div id="main">
  <canvas id="gameCanvas" width="800" height="600"></canvas>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const songListDiv = document.getElementById("songList");
const speedSlider = document.getElementById("speedSlider");
const volumeSlider = document.getElementById("volumeSlider");

let speed = parseFloat(speedSlider.value);
let volume = parseFloat(volumeSlider.value);

speedSlider.oninput = () => speed = parseFloat(speedSlider.value);
volumeSlider.oninput = () => { if(audio) audio.volume = parseFloat(volumeSlider.value); };

let songs = [];
let songData = {};
let notes = [];
let audio, bgImage;
let keyStates = {};
let lineY = 550;

// === Fetch songs from GitHub repo ===
const API_URL = "https://api.github.com/repos/Redwywy2013/Osu-Mania-Player/contents/Songs";

fetch(API_URL).then(r=>r.json()).then(data=>{
  songs = data.filter(f => f.name.endsWith(".osuhtml"));
  renderSongList();
});

function renderSongList() {
  songListDiv.innerHTML = "";
  songs.forEach(file=>{
    let div = document.createElement("div");
    div.className = "song";
    div.textContent = file.name.replace(".osuhtml","");
    div.onclick = () => loadSong(file.download_url);
    songListDiv.appendChild(div);
  });
}

async function loadSong(url) {
  const text = await fetch(url).then(r=>r.text());
  parseOsuhtml(text);
}

function parseOsuhtml(text) {
  songData = { difficulties:{} };

  // Artist - Title
  const atMatch = text.match(/^Artist - Title:\s*(.+)$/m);
  if (atMatch) songData.title = atMatch[1];

  // Difficulties
  const diffRegex = /\[(.+?)\]:\n([\s\S]*?)(?=^\[|\nBackground:|\nAudio Data:|$)/gm;
  let diffMatch;
  while ((diffMatch = diffRegex.exec(text)) !== null) {
    songData.difficulties[diffMatch[1]] = diffMatch[2].trim();
  }

  // Background
  const bgMatch = text.match(/Background:\s*(data:image\/.+)$/m);
  if (bgMatch) {
    songData.background = bgMatch[1];
    bgImage = new Image();
    bgImage.src = songData.background;
  }

  // Audio
  const audioMatch = text.match(/Audio Data:\s*(data:audio\/.+)$/m);
  if (audioMatch) songData.audio = audioMatch[1];

  // Render difficulties
  let diffs = Object.keys(songData.difficulties);
  if (diffs.length) {
    alert(`Loaded ${songData.title}. Choose difficulty: ${diffs.join(", ")}`);
    startGame(diffs[0]); // auto-pick first for now
  }
}

function parseOsuContent(osuText) {
  let hitObjects = [];
  let lines = osuText.split("\n");
  let section = "";
  for (let line of lines) {
    line = line.trim();
    if (line.startsWith("[") && line.endsWith("]")) {
      section = line;
      continue;
    }
    if (section === "[HitObjects]" && line.length > 0) {
      let parts = line.split(",");
      let x = parseInt(parts[0]);
      let time = parseInt(parts[2]);
      let type = parseInt(parts[3]);
      let endTime = parts[5] ? parseInt(parts[5]) : null;
      let column = Math.floor(x / (512/4));
      hitObjects.push({time, column, type, endTime, hit:false});
    }
  }
  return hitObjects;
}

function startGame(diffName) {
  notes = parseOsuContent(songData.difficulties[diffName]);
  audio = new Audio(songData.audio);
  audio.volume = volume;
  audio.play();
  requestAnimationFrame(gameLoop);
}

function gameLoop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Background
  if (bgImage) {
    ctx.globalAlpha = 0.3;
    ctx.drawImage(bgImage,0,0,canvas.width,canvas.height);
    ctx.globalAlpha = 1.0;
  }

  // Judgment line
  ctx.fillStyle = "white";
  ctx.fillRect(0,lineY,canvas.width,5);

  // Columns
  let colWidth = canvas.width/4;
  for (let i=0;i<4;i++) {
    ctx.strokeStyle="#444";
    ctx.strokeRect(i*colWidth,0,colWidth,canvas.height);
  }

  // Notes
  ctx.fillStyle="cyan";
  let currentTime = audio.currentTime * 1000;
  notes.forEach(n=>{
    let timeToHit = n.time - currentTime;
    let y = lineY - timeToHit * (speed*5); // speed multiplier
    if (!n.hit && y < canvas.height) {
      ctx.fillRect(n.column*colWidth+5,y,colWidth-10,20);
    }
  });

  if (!audio.paused) requestAnimationFrame(gameLoop);
}

// Key states
window.addEventListener("keydown", e => keyStates[e.code]=true);
window.addEventListener("keyup", e => keyStates[e.code]=false);
</script>
</body>
</html>
